<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Photo Workflow Manager</title>
    
    <!-- Configurazione PWA -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Inclusione Stili -->
    <link rel="stylesheet" href="/style.css">

    <!-- Inclusione Librerie tramite CDN (per evitare download manuali) -->
    
    <!-- !!! CORREZIONE CRITICA: URL CDN BACKENDLESS AGGIORNATO !!! -->
    <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
    
    <!-- XLSX (SheetJS) per la lettura di Excel (richiesto) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.min.js"></script> 

    <!-- Logica della tua PWA -->
    <script src="./app.js"></script> 
</head>
<body>

    <!-- Area Login (Inizialmente Visibile) -->
    <div id="login-area">
        <h1>Accesso al Workflow Manager</h1>
        <label for="user-email">Email:</label>
        <input type="email" id="user-email" placeholder="nome@azienda.it">
        <br>
        <label for="user-password">Password:</label>
        <input type="password" id="user-password" placeholder="********">
        <br><br>
        <button onclick="
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            handleStandardLogin(email, password);
        ">Accedi</button>
        <p><a href="#" onclick="handlePasswordRecovery(); return false;">Hai dimenticato la password?</a></p>
        <p id="login-status">Inserisci le credenziali.</p>
    </div>

    <!-- --------------------------------------- -->
    <!-- DASHBOARD AMMINISTRATORE (Nascosta) -->
    <!-- --------------------------------------- -->
    <div id="admin-dashboard" style="display:none;">
        <h2>‚öôÔ∏è Dashboard Amministratore</h2>
        
        <!-- 1. Importa Ordini da Excel -->
        <h3>1. Importa Ordini (Fase 1: Prepara Lavoro)</h3>
        <p>Carica un file Excel (colonne: eanCode, cliente) per popolare la tabella Ordini.</p>
        <input type="file" id="excel-file-input" accept=".xlsx, .xls, .csv">
        <button onclick="handleFileUpload()" id="import-button" disabled>Carica Ordini su Database</button>
        <p id="import-status"></p>

        <hr>

        <!-- 2. Gestione Utenti -->
        <h3>2. Gestione Utenti e Ruoli</h3>
        <p>Qui puoi creare nuovi account e assegnare i ruoli (Photographer, PostProducer, Admin).</p>

        <div id="user-creation-form">
            <h4>Crea Nuovo Utente</h4>
            <input type="email" id="new-user-email" placeholder="Email Utente" required>
            <input type="password" id="new-user-password" placeholder="Password Iniziale" required>
            <select id="new-user-role">
                <option value="" disabled selected>Seleziona Ruolo</option>
                <option value="Photographer">Photographer</option>
                <option value="PostProducer">PostProducer</option>
                <option value="Admin">Admin</option>
            </select>
            <button onclick="handleUserCreation()">Crea Account</button>
            <p id="user-creation-status"></p>
        </div>

        <h4 style="margin-top: 30px;">Utenti Esistenti</h4>
        <p id="loading-users">Caricamento utenti...</p>
        <table id="users-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Ruolo Attuale</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- --------------------------------------- -->
    <!-- DASHBOARD LAVORATORE (Nascosta) -->
    <!-- --------------------------------------- -->
    <div id="worker-dashboard" style="display:none;">
        <h2>üëã Benvenuto, <span id="worker-name"></span>!</h2>
        <p>Il tuo Ruolo: <span id="worker-role"></span></p>

        <hr>

        <!-- Sezione Input EAN Manuale -->
        <h3>Aggiornamento Stato Prodotto</h3>
        <p>Inserisci il codice EAN (tramite scanner fisico o digitazione).</p>
        
        <label for="ean-input">Codice EAN:</label>
        <!-- L'evento 'onkeyup' cattura l'invio (Enter) spesso usato dagli scanner fisici -->
        <input type="text" id="ean-input" placeholder="Digita o scansiona l'EAN" onkeyup="if(event.key === 'Enter') confirmEanInput()">
        <button onclick="confirmEanInput()">Conferma EAN</button>
        
        <p id="scan-status">In attesa di EAN...</p>
        
        <hr>

        <!-- Area di Upload Foto (Solo per Photographer, si mostra solo quando un ordine √® in Magazzino) -->
        <div id="photo-upload-area" style="display:none; padding: 20px; border: 1px dashed #007bff; border-radius: 6px; margin-bottom: 20px;">
            <h4>Upload Foto per EAN: <span id="current-ean-display"></span></h4>
            <p>Seleziona tutte le immagini scattate per questo prodotto.</p>
            <input type="file" id="photo-files" multiple accept="image/*">
            <button id="upload-complete-button" onclick="handlePhotoUploadAndCompletion()">Carica e Completa Fasi Foto</button>
            <button class="btn-secondary" onclick="cancelPhotoUpload()">Annulla</button>
            <p id="upload-status-message"></p>
        </div>
        
        <hr>

        <!-- Tabella Ordini in Lavorazione -->
        <h3>Ordini in Attesa di Lavorazione</h3>
        <p id="loading-orders">Caricamento ordini...</p>
        <table id="orders-table">
            <thead>
                <tr>
                    <th>EAN Code</th>
                    <th>Cliente</th>
                    <th>Stato Attuale</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <!-- Modale per Visualizzazione Foto (Post Producer) -->
    <div id="photo-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePhotoModal()">&times;</span>
            <div id="photo-modal-content">
                <!-- Il contenuto (foto e link) viene iniettato qui da JS -->
            </div>
        </div>
    </div>

    <script>
        // Abilita il bottone di importazione Excel quando un file √® selezionato
        document.getElementById('excel-file-input').addEventListener('change', function() {
            // Abilita il pulsante solo se c'√® un file selezionato
            document.getElementById('import-button').disabled = !this.files.length;
        });
    </script>
</body>
</html>

